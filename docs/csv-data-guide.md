# CSV 数据格式与导入指南

## 文件结构

项目使用2个CSV文件存储数据：

- `server/data/default-ranking.csv` - 主数据
- `server/data/data-notes.csv` - 备注数据

## CSV文件格式

### 基本结构

```csv
id,模型名,隐藏,模型全名,即时,输入,输出,备注,LiveBench,LMArena,MC,...,context,cutoff,API名,显示在列名旁,isModel
```

### 特殊控制行 (id 1-6)

这些行定义表格的元数据和行为：

```csv
1,isDataset,否,否,否,否,否,否,是,是,是,...  # 标记哪些列是数据集
2,隐藏,是,是,是,否,否,否,否,否,否,...        # 控制默认隐藏状态
3,显示在模型旁,是,是,是,否,否,否,否,否,否,... # 列信息是否显示在模型名旁
4,数据集全名,是,,,,,,LiveBench,LMArena,...  # 数据集的完整名称
5,备注,是,,,计价单位：$ / M tokens,,...     # 列的说明信息
6,id,,2,3,50,51,52,100,101,102,...          # 每列的数据库ID
```

### 模型数据行 (id 100+)

实际的模型数据，必须设置 `isModel=是`：

```csv
100,o3-high,否,o3-high,否,10,40,,80.71,,56.51,...,200k(100k),2024.6.1,,,是
```

## 数据格式规则

### 多值数据

用 `/` 分隔，系统自动计算平均值：

```
47.1/42.2  → 显示 44.65
96.3,94.4  → 显示 95.35
```

### 推测值

用 `?` 标记推测值：

```
37?/47  → 37为推测值，47为实际值，显示平均值42
85?     → 推测值85
```

### 特殊列说明

**模型信息列** (id < 100):

- `输入` (id=50): 输入价格，美元/百万tokens
- `输出` (id=51): 输出价格，美元/百万tokens
- `context` (id=53): 上下文长度，如 `128K`、`1M`
- `cutoff` (id=54): 知识截止日期，如 `2024.6.1`
- `API名` (id=56): API调用名称
- `即时` (id=57): 是否是推理模型

**数据集列** (id 100+):

- 各种评测数据集的得分
- 支持多值和推测值格式

## ID 分配规则

- **控制行**: 1-6 (固定)
- **模型信息列**: 50-99
- **模型**: 100+ (递增)
- **数据集**: 100+ (递增)

## 数据管理脚本

### 完整导入 (重建数据库)

```bash
cd server
npx tsx scripts/import-csv.ts
```

- 清空现有数据
- 从CSV文件重新构建完整数据库
- 适用于初始化或重大数据更新

### 增量更新 (保留现有数据)

```bash
cd server
npx tsx scripts/update-from-csv.ts
```

- 只更新或添加变更的数据
- 保留数据库中已有的数据点
- 适用于日常数据维护

### 导出到CSV

```bash
cd server
npx tsx scripts/export-to-csv.ts
```

- 将数据库数据导出为CSV文件
- 生成标准格式的主数据和备注文件
- 适用于数据备份或迁移

### 数据备份

```bash
cd server/data
bash back_up.sh
```

- 创建带时间戳的ZIP备份文件
- 备份到 `server/data/private/` 目录
- 包含所有数据文件，排除临时文件

## 导入流程详解

### 1. 解析CSV文件

- 读取两个CSV文件
- 识别特殊控制行 (id 1-6)
- 分离模型数据和配置数据

### 2. 处理控制行

```
id=1: isDataset - 标记哪些列是数据集
id=2: 隐藏 - 默认隐藏状态
id=3: 显示在模型旁 - 模型信息显示配置
id=4: 数据集全名 - 完整名称
id=5: 备注 - 说明信息
id=6: id - 列的数据库ID映射
```

### 3. 导入模型

- 只导入 `isModel=是` 的行
- 跳过控制行 (id 1-6)
- 设置模型的基本信息

### 4. 导入数据集

- 根据控制行创建数据集记录
- 区分模型信息列和评测数据集列
- 设置完整名称和备注

### 5. 导入数据点

- 为每个模型-数据集组合创建数据点
- 处理多值格式 (`47.1/42.2`)
- 处理推测值格式 (`37?`)
- 合并主数据和备注数据

## 数据处理规则

### 多值处理

```
"47.1/42.2" → 平均值 44.65
"96.3,94.4" → 平均值 95.35
```

### 推测值处理

```
"37?/47" → 平均值 42，标记包含推测值
"85?" → 显示 85，标记为推测值
```

### 特殊格式

```
"200k(100k)" → 直接存储为字符串
"2024/6/1" → 转换为 "2024.6.1"
空值 → 存储为 null
```

## 调试方法

```bash
cd server
# 检查数据库
npx prisma studio
```

## 数据维护

### 添加新模型

```csv
130,新模型名,否,完整模型名,否,价格,价格,,分数1,分数2,...,上下文,日期,API名,,是
```

### 添加新数据集

1. 在所有控制行添加新列
2. 为所有现有模型添加该列的评分数据
3. 重新运行导入脚本

### 数据备份与恢复

```bash
# 备份数据库
cp server/prisma/dev.db server/prisma/dev.db.backup

# 恢复数据库
cp server/prisma/dev.db.backup server/prisma/dev.db

# 备份CSV和相关文件
cd server/data
bash back_up.sh
```

### 备注文件

`data-notes.csv` 与主文件结构相同，但存储详细备注信息。每个数据点可以有额外的说明文本。

## 最佳实践

1. **使用增量更新**: 日常维护用 `update-from-csv.ts`，大改动才用 `import-csv.ts`
2. **定期备份**: 重要更改前运行备份脚本
3. **验证数据**: 导入后用 Prisma Studio 检查数据完整性
4. **控制行维护**: 添加新列时确保所有控制行都更新
